<!doctype html>

<html>
  <head>
    <title>HTML Tutor</title>
    <link rel="stylesheet" href="bootstrap.css">
    <style type="text/css">
      #code {
        position: relative;
        top: 0px;
        left: 0px;
        width: 460px;
        height: 400px;
      }


      #result {
        width: 100%;
        height: 400px;
      }


      #assignment li {
        color: #050;
        font-size: 16px;
      }

      section {
        padding-top: 60px;
      }

      .complete {
        color: #ddd;
        font-style: italic;
        text-decoration: line-through;
      }

      .hidden {
        display: none;
      }

      .highlight {
        background-color: #990;
      }
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="js/popcorn-complete.min.js"></script>
    <script type="text/javascript" src="js/jquery.highlight-3.min.js"></script>
    <script type="text/javascript">


var hw_hint = {
  "code" : [ { start: 0, end: 10, text: "Hello, " } ],
  "audio" : "type-world.mp3",
  "highlights" : []};

var ws_hint = {
  "code" : [ { start: 0, end: 4, text: "This is a simple webpage.\nAnd I mean really simple." },
             { start: 6, end: 7, text: "This   is  a   simple    webpage.\nAnd  I  mean     really    simple." },
             { start: 7, end: 8, text: "   This is a simple webpage.\n      And I mean really simple."},
             { start: 8, end: 30, text: "This is a\nsimple webpage.\n\nAnd I mean\nreally simple." }],
  "audio" : "whitespace.mp3",
  "highlights" : []};

var em_hint = {
  "code" : [ { start: 1, end: 30, text: "This text is normal.\n<em>This text is italicized.</em>\n<strong>This text is bold.</strong>" } ],
  "audio" : "tinkering.mp3",
  "highlights" : [ { start: 1, end: 3, textToHighlight: 'This text is italicized'},
  { start: 4, end: 30, textToHighlight: '<em>' } ]
};

var testConstraints = function(win) {
  if ($(win).text().indexOf("Hello, world") >= 0)
    $('#c1').addClass('complete');
  else
    $('#c1').removeClass('complete');

  if ($(win).find('strong:contains("world")').length > 0)
    $('#c2').addClass('complete');
  else
    $('#c2').removeClass('complete');

}

var highlight = function(text) {
  editor.find(text, { regExp: true });
}

var unhighlight = function() {
  editor.find('');
}

var giveHint = function(hint) {

  $('#audio').after($('<audio>').attr('id', 'audio').append($('<source>').attr('src',
          'audio/' + hint.audio)))
             .remove();

  var pop = Popcorn('#audio');

  for(var i=0; i<hint.code.length; i++) {
    var hl = hint.code[i];
    
    (function(hl) {
      var c = pop.code({
        start: hl.start,
        end: hl.end,
        onStart: function() { editor.getSession().setValue(hl.text); },
        onEnd: function() { }
      });
      console.log(c);
    })(hl);
  }
  for(var i=0; i<hint.highlights.length; i++) {
    var hl = hint.highlights[i];
    (function(hl) {
      pop.code({
        start: hl.start,
        end: hl.end,
        onStart: function() { highlight(hl.textToHighlight); },
        onEnd: function() { unhighlight(); }
      });
    })(hl);
  }

  pop.load();
  pop.play();
}

var lastCode = "";

$(document).ready(function() {
  $('#my-modal').modal();



  $('#c1-hint').click(function() {
    giveHint(hw_hint); });

  $('#c2-hint').click(function() {
    giveHint(em_hint); });

  $('#c3-hint').click(function() {
    giveHint(ws_hint); });

});
    </script>
  </head>
  <body>
    <div class="topbar">
      <div class="topbar-inner">
        <div class="container">
          <a class="brand" href="#">HTML Tutor</a>
        </div>
      </div>
    </div>
    <section>
      <div class="container">
        <div class="row" id="assignment">
          <div class="span16">
            <h3>Assignment</h3>
            <audio id="audio">
              <source src="audio/tinkering.mp3"></source>
            </audio>
            <ul id="constraint-list">
              <li id="c1"> Write "Hello, world" 
                  <a id="c1-hint" class="hint-button" href="#">Give me a hint!</a>
              </li>
              <li id="c2">
                  Make "world" bold
                  <a id="c2-hint" class="hint-button" href="#">Give me a hint!</a>
              </li>
              <li id="c3">
                  Put "Hello" and "world" on separate lines
                  <a id="c3-hint" class="hint-button" href="#">Give me a
                    hint!</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="span8">
            <h3>Code</h3>
            <div class="alert-message success hidden">
              <a class="close" href="#">x</a>
              <p><strong>Holy guacamole!</strong> Best check yo self, you're not looking too good.</p>
            </div>

            <div id="code"></div>
            <script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
            <script src="js/ace/mode-html.js" type="text/javascript" charset="utf-8"></script>
            <script>
            window.onload = function() {
                editor = ace.edit("code");

                var HtmlMode = require("ace/mode/html").Mode;
                editor.getSession().setMode(new HtmlMode());

                editor.getSession().on('change', function() {

                  var curCode = editor.getSession().getValue();
                  if (curCode != lastCode) {
                    var doc = $('#result')[0],
                        win = doc.contentDocument || doc.contentWindow.document;

                    win.open();
                    win.write(curCode);
                    testConstraints(win);
                    win.close();
                  }  
                });
            };
            </script> 

          </div>
          <div class="span8">
            <h3>Result</h3>
            <iframe id="result"></iframe>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>
